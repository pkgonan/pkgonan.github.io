---
layout: post
cover: '/assets/images/cover10.jpg'
title: 쿠폰 재고의 설계 및 개발
date: 2020-03-17 00:00:00
tags: Stock
subclass: 'post tag-dev'
categories: 'pkgonan' 
navigation: True
---


## 알림
> 본 설계 및 소스코드는 재 구성한 것으로, 실제와 다른 부분이 있음을 알려드립니다.


## 배경
* 쿠폰 비용을 제한할 수 있는, 쿠폰 재고 도메인 개발을 진행하게 되었습니다.
* 쿠폰의 재고는 두가지로 나뉩니다.
    * 첫째, 지급 재고
    * 둘째, 사용 재고
* 지급 재고는, 사용자에게 쿠폰을 몇 번 지급할 수 있는지 결정합니다.
* 사용 재고는, 사용자가 쿠폰을 몇 번 사용할 수 있는지 결정합니다.
* 즉, 쿠폰 재고 도메인을 통해 쿠폰을 활용하는 마케팅 비용을 제한할 수 있게 됩니다.


## 목표
* 재고 도메인을 개발하여, 쿠폰의 지급/사용 횟수를 제한할 수 있는 기능을 개발.


## KeyPoint
* 개발에 앞서, 가장 중요한 KeyPoint를 정리해보면 아래와 같습니다.
    * 설계와 성능의 이점을 모두 챙겨야 합니다.
    * 재고 조회/삽입/삭제/변경의 성능은 시간복잡도 O(1)을 만족해야 합니다.
    * 재고 증가/감소의 동시성 이슈를 해소해야 합니다.
    * 비동기 처리가 가능해야 합니다.
    * 재고 도메인은 확장에 열려있어야 합니다. 어떠한 재고도 표현 가능해야 합니다.


## KeyPoint와 의사 결정
* 설계는 JPA 기반의 Entity 설계로, 성능은 실시간 재고 처리 부분을 Redis로 분리하여 만족시킵니다.
* 재고의 조회/삽입/삭제/변경의 시간복잡도를 만족하기 위해, 저장소를 O(logN)의 시간복잡도를 가지는 RDB가 아닌 Redis로 결정하였습니다.
* 재고 증가/감소의 동시성 이슈는 Single Thread인 Redis를 사용하면 쉽게 해결 가능합니다.
* 비동기 처리를 위해 JDBC Level에서 Blocking 될 수 있는 RDB가 아닌, Redis로 결정하였습니다.
* 재고 도메인은 쉽게 확장 가능해야 합니다. 따라서, 재고 도메인은 가장 기본적인 정보만 담아야 하며, 재고를 활용하는 각 도메인에서 Redis Key 생성 방식을 결정하게 됩니다.


## 기본적인 구조 설명
* 재고 도메인을 표현하기 위해 아래와 같은 구조로 설계하였습니다.
    * 첫째, 재고 제한 설정을 의미하는 Stock Entity 도메인
    * 둘째, Reactive를 지원하는 Global AtomicLong 개념의 Gauge 도메인
    * 셋째, 재고를 사용하는 각 도메인에 위치하여, 재고를 사용하려는 각 도메인과 재고 도메인을 연결해주는 중간자 클래스. (각 도메인의 관심사에 맞는 재고 Key Generator 등)
* 재고 도메인의 활용 방법
    * 쿠폰 사용을 담당하는 도메인에 재고 도메인을 넣어, 쿠폰 사용 재고 설정을 가능하게 합니다.
    * 쿠폰 지급을 담당하는 도메인에 재고 도메인을 넣어, 쿠폰 지급 재고 설정을 가능하게 합니다.
* 쿠폰의 흐름과 재고 도메인의 활용 방법
    * 쿠폰의 설정
        * 쿠폰에는 확정 기능이 존재하며, 확정시 재고 설정에 있는 total 값을 Redis에 저장합니다.
            * 이는, 운영 중에 재고가 남아있는지 여부를 체크하기 위해 total값을 조회하지 않기 위해 저장합니다.
            * 쉽게 설명 한다면, 성능을 위해 사용한 쿠폰 수를 저장하는 방식이 아닌, 남아 있는 재고 수를 저장하는 방식을 사용합니다.
            * 사용한 쿠폰 수를 저장하는 방식의 경우, 재고가 남아있는지 여부를 체크하기 위해 매번 총 재고 설정 값과 현재 사용한 쿠폰 수를 두번 조회해야하기 때문입니다.
                * long remain = total - used;
        * 확정된 쿠폰만 지급 혹은 사용될 수 있습니다.
    * 쿠폰 설정 후 지급 및 사용
        * 쿠폰을 사용 혹은 지급 처리 시, 쿠폰에 재고 설정이 있는지 확인합니다.
        * 재고 설정이 존재한다면, 각 도메인에 위치한 중간자 클래스를 통해 재고 Key를 생성 후, Gauge 도메인을 활용하여 Redis를 통해 재고를 증가/감소합니다.
    

## 재고 도메인의 설계
* 간단한 구조의 재고 도메인
* ![Stock Domain](/assets/images/post/stock_domain.png)
* Stock은 Entity로 RDB에 저장
* 재고 도메인은 = 재고 제한 설정을 의미합니다, 재고 도메인을 사용하는 도메인에서 재고 제한 설정이 없으면 무제한을 의미합니다.
* total은 총 설정 재고, remain은 남아 있는 재고를 의미합니다.
* 이때, remain은 실제 주문 흐름중에 사용되는 실시간 재고가 아닙니다.
    * 관리자에서 각 쿠폰을 조회시 재고 총 설정 및 현황을 Lazy하게 조회하기 위해 사용되며, 재고의 영구 저장을 위해 사용됩니다.
    * remain은 Lazy하기에 sync API를 제공하여 Redis의 실시간 재고를 RDB로 Sync하는 API를 관리자 화면에서 제공하여 Refresh가 가능하게 합니다.
    * 나아가, Redis를 재고 저장소로 사용하지만, 쿠폰의 지급 및 사용 기간이 종료되면 영구 저장소인 RDB로 이관 및 저장하여 관리하기 위해 사용합니다.
    * 결론적으로, Redis는 Atomic Operation을 지원하는 단기 저장소로 사용, 지급/사용 기간이 만료된 쿠폰은 영구 저장소인 RDB로 재고 정보를 이관하여 관리합니다.
    

## Gauge 도메인의 설계
* 간단한 구조의 Gauge 도메인
* ![Gauge Domain](/assets/images/post/gauge_domain.png)
* Gauge는 Entity가 아닙니다.
* GaugeRepository - Gauge Repository Implementation
* ![Gauge Repository Implementation](/assets/images/post/gauge_repository.png)
* Gauge 도메인은, Reactive Streams Spec을 따르는 Reactor 기반으로 동작합니다.
* Global AtomicLong 연산을 지원하는 도메인이 Gauge 도메인이라고 할 수 있습니다.


## Gauge 도메인에서 활용하는 ReactiveRepository
* ReactiveRepository들은 공통 도메인 패키지에 위치합니다.
* ReactiveRepository - Reactive Operation Interface
* ![Reactive Repository](/assets/images/post/reactive_repository.png)
* ReactiveRedisRepository - Redis Common Operation Interface
* ![Reactive Redis Repository](/assets/images/post/reactive_redis_repository.png)
* ReactiveRedisValueRepository - Redis Value Operation Interface
* ![Reactive Redis Value Repository](/assets/images/post/reactive_redis_value_repository.png)
* AbstractReactiveRedisRepository - Abstract Redis Common Operation Implementation
* ![Reactive Redis Repository Implementation](/assets/images/post/abstract_reactive_redis_repository.png)
* AbstractReactiveRedisValueRepository - Abstract Redis Value Operation Implementation
* ![Reactive Redis Value Repository Implementation](/assets/images/post/abstract_reactive_redis_repository.png)


## 쿠폰과 재고 그리고 Gauge 도메인의 연동
* TBD


## 결과
* TBD


## 마치며
* TBD